name: IAR Demo - Python Classifier Tests

on:
  push:
    branches: ["main"]
    paths:
      - "iar-demo/api/**"
      - ".github/workflows/iar-demo-python-tests.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "iar-demo/api/**"
      - ".github/workflows/iar-demo-python-tests.yml"

jobs:
  test-python-classifier:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python (with pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            iar-demo/api/requirements-dev.txt

      - name: Install test deps
        working-directory: iar-demo
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements-dev.txt

      - name: Detect changed files
        id: changes
        shell: bash
        run: |
          set -e

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # Sometimes BEFORE is empty or all zeros (e.g., first push, weird event payloads)
          if [ -z "$BEFORE" ] || echo "$BEFORE" | grep -q '^0\+$'; then
            BEFORE="$(git rev-parse "${AFTER}~1" 2>/dev/null || true)"
          fi

          CHANGED=""
          if [ -n "$BEFORE" ]; then
            CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          fi

          # Prefer changes under iar-demo/api (since that's what your demo cares about)
          CHANGED_API="$(echo "$CHANGED" | grep '^iar-demo/api/' || true)"

          if [ -n "$CHANGED_API" ]; then
            LIST="$(echo "$CHANGED_API" | sed 's|^iar-demo/api/||' | head -n 3 | paste -sd ', ' -)"
            COUNT="$(echo "$CHANGED_API" | wc -l | tr -d ' ')"
            if [ "$COUNT" -gt 3 ]; then
              echo "what=iar-demo/api: $LIST (+$((COUNT-3)) more)" >> "$GITHUB_OUTPUT"
            else
              echo "what=iar-demo/api: $LIST" >> "$GITHUB_OUTPUT"
            fi
          elif [ -n "$CHANGED" ]; then
            # Non-api changes happened (rare for this workflow, but handle cleanly)
            LIST="$(echo "$CHANGED" | head -n 3 | paste -sd ', ' -)"
            COUNT="$(echo "$CHANGED" | wc -l | tr -d ' ')"
            if [ "$COUNT" -gt 3 ]; then
              echo "what=$LIST (+$((COUNT-3)) more)" >> "$GITHUB_OUTPUT"
            else
              echo "what=$LIST" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "what=repo files" >> "$GITHUB_OUTPUT"
          fi

      - name: Run pytest + coverage (verbose + colored)
        working-directory: iar-demo
        run: |
          pytest -vv --tb=no -r0 --color=yes api/tests \
            --junitxml=pytest-results.xml \
            --cov=api \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --cov-report=xml:coverage.xml

      - name: Upload coverage HTML artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: iar-demo-coverage-html
          path: iar-demo/htmlcov
          retention-days: 7

      - name: Send Telegram notification
        if: always()
        working-directory: iar-demo
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CLASS_CHAT_ID: ${{ secrets.TELEGRAM_CLASS_CHAT_ID }}

          ACTOR: ${{ github.actor }}
          STATUS: ${{ job.status }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}

          WHAT_CHANGED: ${{ steps.changes.outputs.what }}
        shell: bash
        run: |
          python - <<'PY'
          import os
          import xml.etree.ElementTree as ET
          import urllib.request
          import urllib.parse

          bot = os.environ.get("TELEGRAM_BOT_TOKEN", "").strip()
          chat_default = os.environ.get("TELEGRAM_CHAT_ID", "").strip()
          chat_class = os.environ.get("TELEGRAM_CLASS_CHAT_ID", "").strip()

          actor = os.environ.get("ACTOR", "someone")
          status = os.environ.get("STATUS", "unknown")
          sha = os.environ.get("SHA", "")[:7]
          run_url = f"https://github.com/{os.environ.get('REPO','')}/actions/runs/{os.environ.get('RUN_ID','')}"
          commit_msg = os.environ.get("COMMIT_MSG", "")
          what_changed = os.environ.get("WHAT_CHANGED", "iar-demo/api/*")

          # Pick chat: default DM, unless commit contains "class demo" and class chat id exists
          target_chat = chat_default
          if "class demo" in commit_msg.lower() and chat_class:
              target_chat = chat_class

          # Parse coverage %
          coverage_pct = "Unknown"
          try:
              tree = ET.parse("coverage.xml")
              root = tree.getroot()
              line_rate = root.attrib.get("line-rate")
              if line_rate is not None:
                  coverage_pct = f"{round(float(line_rate) * 100)}%"
          except Exception:
              pass

          # Parse test results from JUnit XML (list each test case)
          tests_lines = []
          try:
              t = ET.parse("pytest-results.xml")
              r = t.getroot()

              # Some JUnit formats wrap suites; handle both
              testcase_elems = r.findall(".//testcase")

              for tc in testcase_elems:
                  name = tc.attrib.get("name", "unknown_test")
                  # failures/errors/skips
                  failed = tc.find("failure") is not None or tc.find("error") is not None
                  skipped = tc.find("skipped") is not None

                  if skipped:
                      icon = "â­ï¸"
                  elif failed:
                      icon = "âŒ"
                  else:
                      icon = "âœ…"

                  tests_lines.append(f"{icon} {name}")

              # If empty for some reason
              if not tests_lines:
                  tests_lines = ["(No tests parsed â€” check Actions log)"]
          except Exception:
              tests_lines = ["(Unable to parse test list â€” check Actions log)"]

          emoji = "ðŸŸ¢" if status == "success" else "ðŸ”´"
          header = "SUCCESS" if status == "success" else status.upper()

          msg = "\n".join([
              f"{emoji} IAR CI: {header}",
              f"{actor} pushed {what_changed}",
              f"Commit: {sha}",
              f"Coverage: {coverage_pct}",
              "",
              "Tests:",
              *tests_lines,
              "",
              f"View run: {run_url}",
          ])

          if not bot or not target_chat:
              print("Telegram not configured (missing bot token or chat id).")
              raise SystemExit(0)

          url = f"https://api.telegram.org/bot{bot}/sendMessage"
          data = urllib.parse.urlencode({
              "chat_id": target_chat,
              "text": msg,
              "disable_web_page_preview": "true",
          }).encode("utf-8")

          req = urllib.request.Request(url, data=data, method="POST")
          with urllib.request.urlopen(req, timeout=20) as resp:
              print(resp.read().decode("utf-8"))
          PY