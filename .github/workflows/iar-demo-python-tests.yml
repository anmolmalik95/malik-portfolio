name: IAR Demo - Python Classifier Tests

on:
  push:
    branches: ["main"]
    paths:
      - "iar-demo/api/**"
      - ".github/workflows/iar-demo-python-tests.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "iar-demo/api/**"
      - ".github/workflows/iar-demo-python-tests.yml"

jobs:
  test-python-classifier:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            iar-demo/api/requirements-dev.txt

      - name: Install test deps
        working-directory: iar-demo
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements-dev.txt

      - name: Run pytest + coverage (verbose + colored)
        working-directory: iar-demo
        env:
          PY_COLORS: "1"
          FORCE_COLOR: "1"
        run: |
          pytest -vv --tb=short --color=yes api/tests \
            --cov=api \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            | tee pytest_output.txt

      - name: Upload coverage HTML artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: iar-demo-coverage-html
          path: iar-demo/htmlcov
          retention-days: 7

      - name: Send Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CLASS_CHAT_ID: ${{ secrets.TELEGRAM_CLASS_CHAT_ID }}
        run: |
          set -euo pipefail

          STATUS="${{ job.status }}"
          ACTOR="${{ github.actor }}"
          SHORT_SHA="${GITHUB_SHA::7}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          TARGET_CHAT_ID="$TELEGRAM_CHAT_ID"
          if echo "$COMMIT_MSG" | grep -qi "class demo" && [ -n "${TELEGRAM_CLASS_CHAT_ID:-}" ]; then
            TARGET_CHAT_ID="$TELEGRAM_CLASS_CHAT_ID"
          fi

          if [ "$STATUS" = "success" ]; then
            EMOJI="üü¢"
          else
            EMOJI="üî¥"
          fi

          # Coverage like "100%" from the TOTAL line
          COVERAGE="$(grep -E '^TOTAL' iar-demo/pytest_output.txt | awk '{print $4}' | head -n 1)"
          if [ -z "${COVERAGE:-}" ]; then
            COVERAGE="Unknown"
          fi

          # Build test summary (one line per test)
          TEST_SUMMARY=""
          while IFS= read -r line; do
            NAME="$(echo "$line" | sed -E 's/.*::(test_[^ ]+).*/\1/')"
            if echo "$line" | grep -q "PASSED"; then
              TEST_SUMMARY="${TEST_SUMMARY}\n‚úÖ ${NAME}"
            else
              TEST_SUMMARY="${TEST_SUMMARY}\n‚ùå ${NAME}"
            fi
          done < <(grep -E "api/tests/.*::test_.* (PASSED|FAILED)" iar-demo/pytest_output.txt || true)

          if [ -z "${TEST_SUMMARY:-}" ]; then
            TEST_SUMMARY="\n(Unable to parse test list ‚Äî check Actions log)"
          fi

          MESSAGE="$(printf "<b>%s IAR CI: %s</b>\n\n<b>%s</b> pushed <code>classify.py</code>\nCommit: <code>%s</code>\nCoverage: <b>%s</b>\n\n<b>Tests:</b>%b\n\n<a href=\"%s\">View run</a>" \
            "$EMOJI" "${STATUS^^}" "$ACTOR" "$SHORT_SHA" "$COVERAGE" "$TEST_SUMMARY" "$RUN_URL")"

          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TARGET_CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true"