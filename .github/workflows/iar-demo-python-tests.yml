name: IAR Demo - Python Classifier Tests

on:
  push:
    branches: ["main"]
    paths:
      - "iar-demo/api/**"
      - ".github/workflows/iar-demo-python-tests.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "iar-demo/api/**"
      - ".github/workflows/iar-demo-python-tests.yml"

jobs:
  test-python-classifier:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            iar-demo/api/requirements-dev.txt

      - name: Install test deps
        working-directory: iar-demo
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements-dev.txt

      - name: Run pytest + coverage (verbose + colored)
        working-directory: iar-demo
        shell: bash
        env:
          PY_COLORS: "1"
          FORCE_COLOR: "1"
        run: |
          set -euo pipefail
          pytest -vv --tb=short --color=yes api/tests \
            --cov=api \
            --cov-report=term-missing \
            --cov-report=html:htmlcov | tee pytest_output.txt

      - name: Upload coverage HTML artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: iar-demo-coverage-html
          path: iar-demo/htmlcov
          retention-days: 7

      - name: Send Telegram notification
        if: always()
        working-directory: iar-demo
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CLASS_CHAT_ID: ${{ secrets.TELEGRAM_CLASS_CHAT_ID }}
        run: |
          set -euo pipefail

          STATUS="${{ job.status }}"
          ACTOR="${{ github.actor }}"
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          # Decide where to send: default to your DM chat_id, switch only if:
          #  - commit message contains "class demo"
          #  - TELEGRAM_CLASS_CHAT_ID is set AND not a placeholder
          TARGET_CHAT_ID="${TELEGRAM_CHAT_ID}"
          if echo "${COMMIT_MSG}" | grep -qi "class demo" && \
             [ -n "${TELEGRAM_CLASS_CHAT_ID:-}" ] && \
             [ "${TELEGRAM_CLASS_CHAT_ID}" != "DISABLED_FOR_NOW" ]; then
            TARGET_CHAT_ID="${TELEGRAM_CLASS_CHAT_ID}"
          fi

          if [ "${STATUS}" = "success" ]; then
            EMOJI="üü¢"
          else
            EMOJI="üî¥"
          fi

          # Detect if classify.py changed in this commit (nice for your message)
          CHANGED_FILES="$(git show --name-only --pretty="" "${GITHUB_SHA}" || true)"
          if echo "${CHANGED_FILES}" | grep -q "^iar-demo/api/classify.py$"; then
            WHAT_CHANGED="classify.py"
          else
            WHAT_CHANGED="IAR demo code"
          fi

          # Pull coverage % from the saved pytest output
          COVERAGE="$(grep -E "^TOTAL" pytest_output.txt | awk '{print $NF}' | tail -n 1 || true)"
          if [ -z "${COVERAGE}" ]; then
            COVERAGE="Unknown (see Actions log)"
          fi

          # Pull the 4 test lines from saved output and format them nicely
          TEST_BLOCK="$(grep -E "^api/tests/test_classify.py::" pytest_output.txt | sed -E 's/[[:space:]]+\[[^]]+\]//g' | tail -n 50 || true)"
          PRETTY_TESTS=""
          if [ -n "${TEST_BLOCK}" ]; then
            while IFS= read -r line; do
              if echo "${line}" | grep -q "PASSED"; then
                PRETTY_TESTS="${PRETTY_TESTS}‚úÖ ${line}\n"
              elif echo "${line}" | grep -q "FAILED"; then
                PRETTY_TESTS="${PRETTY_TESTS}‚ùå ${line}\n"
              else
                PRETTY_TESTS="${PRETTY_TESTS}‚Ä¢ ${line}\n"
              fi
            done <<< "${TEST_BLOCK}"
          else
            PRETTY_TESTS="(Could not parse test list ‚Äî see Actions log)\n"
          fi

          # Build message with real newlines
          MESSAGE="${EMOJI} IAR CI: ${STATUS}
${ACTOR} pushed ${WHAT_CHANGED}
Commit: ${SHORT_SHA}
Coverage: ${COVERAGE}

Tests:
${PRETTY_TESTS}
View run: ${RUN_URL}"

          # Send (urlencode preserves newlines cleanly)
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TARGET_CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}" \
            -d "disable_web_page_preview=true" \
            >/dev/null