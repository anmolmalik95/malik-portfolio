name: IAR Demo - Python Classifier Tests

on:
  push:
    branches: ["main"]
    paths:
      - "iar-demo/api/**"
      - ".github/workflows/iar-demo-python-tests.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "iar-demo/api/**"
      - ".github/workflows/iar-demo-python-tests.yml"

jobs:
  test-python-classifier:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python (with pip cache)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            iar-demo/api/requirements-dev.txt

      - name: Install test deps
        working-directory: iar-demo
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements-dev.txt

      - name: Detect changed files
        id: changes
        shell: bash
        run: |
          set -e

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [ -z "$BEFORE" ] || echo "$BEFORE" | grep -q '^0\+$'; then
            BEFORE="$(git rev-parse "${AFTER}~1" 2>/dev/null || true)"
          fi

          CHANGED=""
          if [ -n "$BEFORE" ]; then
            CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          fi

          CHANGED_API="$(echo "$CHANGED" | grep '^iar-demo/api/' || true)"

          if echo "$CHANGED_API" | grep -q '^iar-demo/api/classify\.py$'; then
            echo "what=classify.py" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -n "$CHANGED_API" ]; then
            LIST="$(echo "$CHANGED_API" | sed 's|^iar-demo/api/||' | head -n 3 | paste -sd ', ' -)"
            COUNT="$(echo "$CHANGED_API" | wc -l | tr -d ' ')"
            if [ "$COUNT" -gt 3 ]; then
              echo "what=iar-demo/api: $LIST (+$((COUNT-3)) more)" >> "$GITHUB_OUTPUT"
            else
              echo "what=iar-demo/api: $LIST" >> "$GITHUB_OUTPUT"
            fi
          elif [ -n "$CHANGED" ]; then
            LIST="$(echo "$CHANGED" | head -n 3 | paste -sd ', ' -)"
            COUNT="$(echo "$CHANGED" | wc -l | tr -d ' ')"
            if [ "$COUNT" -gt 3 ]; then
              echo "what=$LIST (+$((COUNT-3)) more)" >> "$GITHUB_OUTPUT"
            else
              echo "what=$LIST" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "what=repo files" >> "$GITHUB_OUTPUT"
          fi

      - name: Run pytest + coverage (verbose + colored)
        working-directory: iar-demo
        env:
          PY_COLORS: "1"
          FORCE_COLOR: "1"
        run: |
          pytest -vv --tb=no --no-summary -r0 --color=yes api/tests \
            --junitxml=pytest-results.xml \
            --cov=api \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --cov-report=xml:coverage.xml

      - name: Upload coverage HTML artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: iar-demo-coverage-html
          path: iar-demo/htmlcov
          retention-days: 7

      - name: Send Telegram notification
        if: always()
        working-directory: iar-demo
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CLASS_CHAT_ID: ${{ secrets.TELEGRAM_CLASS_CHAT_ID }}

          ACTOR: ${{ github.actor }}
          STATUS: ${{ job.status }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          WHAT_CHANGED: ${{ steps.changes.outputs.what }}
        shell: bash
        run: |
          python - <<'PY'
          import os
          import xml.etree.ElementTree as ET
          import urllib.request
          import urllib.parse

          bot = (os.environ.get("TELEGRAM_BOT_TOKEN") or "").strip()
          chat_me = (os.environ.get("TELEGRAM_CHAT_ID") or "").strip()
          chat_class = (os.environ.get("TELEGRAM_CLASS_CHAT_ID") or "").strip()

          actor = os.environ.get("ACTOR", "someone")
          status = os.environ.get("STATUS", "unknown")
          sha = (os.environ.get("SHA", "") or "")[:7]
          repo = os.environ.get("REPO", "")
          run_id = os.environ.get("RUN_ID", "")
          run_url = f"https://github.com/{repo}/actions/runs/{run_id}"
          commit_msg = os.environ.get("COMMIT_MSG", "") or ""
          what_changed = os.environ.get("WHAT_CHANGED", "repo files")

          # Decide recipients: ALWAYS DM; PLUS class group if keyword + id present
          send_to = []
          if chat_me:
              send_to.append(chat_me)

          if ("class demo" in commit_msg.lower()) and chat_class:
              # send to both (avoid duplicates)
              if chat_class not in send_to:
                  send_to.append(chat_class)

          if not bot or not send_to:
              print("Telegram not configured (missing token or chat ids).")
              raise SystemExit(0)

          # Parse coverage % from coverage.xml
          coverage_pct = "Unknown"
          try:
              root = ET.parse("coverage.xml").getroot()
              line_rate = root.attrib.get("line-rate")
              if line_rate is not None:
                  coverage_pct = f"{round(float(line_rate) * 100)}%"
          except Exception:
              pass

          # Parse test results from JUnit XML
          tests_lines = []
          try:
              r = ET.parse("pytest-results.xml").getroot()
              for tc in r.findall(".//testcase"):
                  name = tc.attrib.get("name", "unknown_test")
                  failed = (tc.find("failure") is not None) or (tc.find("error") is not None)
                  skipped = (tc.find("skipped") is not None)
                  if skipped:
                      icon = "â­ï¸"
                  elif failed:
                      icon = "âŒ"
                  else:
                      icon = "âœ…"
                  tests_lines.append(f"{icon} {name}")

              if not tests_lines:
                  tests_lines = ["(No tests parsed â€” check Actions log)"]
          except Exception:
              tests_lines = ["(Unable to parse test list â€” check Actions log)"]

          emoji = "ðŸŸ¢" if status == "success" else "ðŸ”´"
          header = "SUCCESS" if status == "success" else status.upper()

          msg = "\n".join([
              f"{emoji} IAR CI: {header}",
              f"{actor} pushed {what_changed}",
              f"Commit: {sha}",
              f"Coverage: {coverage_pct}",
              "",
              "Tests:",
              *tests_lines,
              "",
              f"View run: {run_url}",
          ])

          url = f"https://api.telegram.org/bot{bot}/sendMessage"

          def send(chat_id: str):
              data = urllib.parse.urlencode({
                  "chat_id": chat_id,
                  "text": msg,
                  "disable_web_page_preview": "true",
              }).encode("utf-8")
              req = urllib.request.Request(url, data=data, method="POST")
              with urllib.request.urlopen(req, timeout=20) as resp:
                  print(resp.read().decode("utf-8"))

          for cid in send_to:
              send(cid)
          PY